<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Bibliotec√°rio de Refer√™ncia</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f5f5f5;
  display: flex;
  justify-content: center;
  padding: 30px;
}

.chat {
  background: #ffffff;
  width: 100%;
  max-width: 760px;
  padding: 24px;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

.header h2 {
  margin: 0;
  font-size: 22px;
}

.header p {
  margin-top: 6px;
  font-size: 14px;
  color: #555;
}

.notice {
  background: #f0f4f8;
  border-left: 4px solid #2a6ebb;
  padding: 12px;
  font-size: 14px;
  margin: 16px 0;
  color: #333;
}

.messages {
  max-height: 420px;
  overflow-y: auto;
  margin-bottom: 16px;
  padding-right: 8px;
}

.user {
  margin-top: 14px;
  font-weight: bold;
}

.bot {
  margin-left: 10px;
  margin-top: 6px;
  margin-bottom: 10px;
  line-height: 1.5;
}

.loading {
  margin-left: 10px;
  font-style: italic;
  color: #666;
}

textarea {
  width: 100%;
  height: 80px;
  padding: 10px;
  font-size: 14px;
  box-sizing: border-box;
}

.buttons {
  margin-top: 10px;
}

button {
  padding: 10px 16px;
  font-size: 14px;
  cursor: pointer;
  margin-right: 8px;
}

.footer {
  margin-top: 14px;
  font-size: 12px;
  color: #777;
}
</style>
</head>

<body>
<div class="chat" id="chat">

  <div class="header">
    <h2>Bibliotec√°rio de Refer√™ncia Virtual</h2>
    <p>Um apoio para encontrar informa√ß√µes nos documentos da biblioteca.</p>
  </div>

  <div class="notice">
    Ol√°! üëã  
    Sou o <strong>bibliotec√°rio de refer√™ncia virtual</strong>.
    <br><br>
    Estou aqui para conversar com voc√™ e ajudar a encontrar informa√ß√µes
    nos documentos dispon√≠veis da biblioteca.
    <br><br>
    A conversa acontece apenas enquanto esta p√°gina estiver aberta.
  </div>

  <div class="messages" id="messages">
    <div class="bot" id="welcome-message">
      üìö <strong>Bibliotec√°rio:</strong> Vamos conversar?  
      Digite aqui a sua intera√ß√£o.
    </div>
  </div>

  <textarea
    id="question"
    placeholder="Digite sua pergunta aqui‚Ä¶">
  </textarea>

  <div class="buttons">
    <button onclick="send()">Perguntar</button>
    <button onclick="printChat()">Imprimir / Salvar em PDF</button>
  </div>

  <div class="footer">
    Este assistente apoia o atendimento, mas n√£o substitui o bibliotec√°rio quando necess√°rio.
  </div>
</div>

<script>
let conversation = [];
const MAX_HISTORY = 6;
let firstInteraction = true;

function render(role, text, className) {
  const div = document.createElement("div");
  div.className = className || role;

  div.innerHTML = text
    .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
    .replace(/\n/g, "<br>");

  document.getElementById("messages").appendChild(div);
  document.getElementById("messages").scrollTop =
    document.getElementById("messages").scrollHeight;

  return div;
}

async function send() {
  const input = document.getElementById("question");
  const q = input.value.trim();
  if (!q) return;

  // Remove a mensagem inicial na primeira intera√ß√£o
  if (firstInteraction) {
    const welcome = document.getElementById("welcome-message");
    if (welcome) welcome.remove();
    firstInteraction = false;
  }

  render("user", "<strong>Voc√™:</strong> " + q, "user");
  input.value = "";

  conversation.push({ role: "user", content: q });
  const history = conversation.slice(-MAX_HISTORY);

  const loadingDiv = render(
    "bot",
    "üìö <em>O bibliotec√°rio est√° consultando os documentos‚Ä¶</em>",
    "loading"
  );

  const res = await fetch("/ask", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ question: q, history: history })
  });

  const data = await res.json();

  loadingDiv.remove();

  render(
    "bot",
    "<strong>Bibliotec√°rio:</strong> " + data.answer,
    "bot"
  );

  conversation.push({ role: "assistant", content: data.answer });
}

function printChat() {
  const original = document.body.innerHTML;
  const chat = document.getElementById("chat").innerHTML;

  document.body.innerHTML = `
    <h2>Registro da conversa</h2>
    <hr>
    ${chat}
  `;

  window.print();
  document.body.innerHTML = original;
}
</script>

</body>
</html>
